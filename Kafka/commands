Kafka + Zookeeper Setup on Amazon Linux
1️⃣ Directory Setup
# Create directories for persistent storage
sudo mkdir -p /mnt/zookeeper /mnt/kafka

# Set ownership and permissions
sudo chown -R ec2-user:ec2-user /mnt/zookeeper /mnt/kafka
sudo chmod -R 755 /mnt/zookeeper /mnt/kafka


/mnt/zookeeper → stores all Zookeeper state

/mnt/kafka → stores all Kafka topic data

2️⃣ Zookeeper Configuration

File: /opt/kafka/config/zookeeper.properties

dataDir=/mnt/zookeeper
clientPort=2181
tickTime=2000
initLimit=5
syncLimit=2


Start manually (for debugging):

/opt/kafka/bin/zookeeper-server-start.sh /opt/kafka/config/zookeeper.properties


Verify running:

sudo systemctl status zookeeper
/opt/kafka/bin/zkCli.sh -server localhost:2181

3️⃣ Kafka Configuration

File: /opt/kafka/config/server.properties

broker.id=1
log.dirs=/mnt/kafka
zookeeper.connect=localhost:2181

listeners=SASL_PLAINTEXT://:9092
advertised.listeners=SASL_PLAINTEXT://localhost:9092

offsets.topic.replication.factor=1
transaction.state.log.replication.factor=1
transaction.state.log.min.isr=1

authorizer.class.name=kafka.security.auth.SimpleAclAuthorizer
allow.everyone.if.no.acl.found=true
super.users=User:kafka
sasl.enabled.mechanisms=PLAIN
sasl.mechanism.inter.broker.protocol=PLAIN
security.inter.broker.protocol=SASL_PLAINTEXT

Kafka JAAS configuration

File: /opt/kafka/config/kafka_server_jaas.conf

KafkaServer {
    org.apache.kafka.common.security.plain.PlainLoginModule required
    username="kafka"
    password="kafuptm"
    user_kafka="kafuptm";
};


Set environment variable for systemd:

export KAFKA_OPTS="-Djava.security.auth.login.config=/opt/kafka/config/kafka_server_jaas.conf"

4️⃣ Systemd Services
Zookeeper service /etc/systemd/system/zookeeper.service
[Unit]
Description=Zookeeper Service
After=network.target

[Service]
Type=simple
User=ec2-user
ExecStart=/opt/kafka/bin/zookeeper-server-start.sh /opt/kafka/config/zookeeper.properties
ExecStop=/opt/kafka/bin/zookeeper-server-stop.sh
Restart=on-failure

[Install]
WantedBy=multi-user.target

Kafka service /etc/systemd/system/kafka.service
[Unit]
Description=Kafka Service
After=zookeeper.service
Requires=zookeeper.service

[Service]
Type=simple
User=ec2-user
Environment="KAFKA_OPTS=-Djava.security.auth.login.config=/opt/kafka/config/kafka_server_jaas.conf"
ExecStart=/opt/kafka/bin/kafka-server-start.sh /opt/kafka/config/server.properties
ExecStop=/opt/kafka/bin/kafka-server-stop.sh
Restart=on-failure

[Install]
WantedBy=multi-user.target

5️⃣ Start & Enable Services
sudo systemctl daemon-reload

sudo systemctl start zookeeper
sudo systemctl enable zookeeper

sudo systemctl start kafka
sudo systemctl enable kafka

6️⃣ Verify Services
sudo systemctl status zookeeper
sudo systemctl status kafka

netstat -tulnp | grep 2181   # Zookeeper
netstat -tulnp | grep 9092   # Kafka

/opt/kafka/bin/kafka-topics.sh --bootstrap-server localhost:9092 --list
